/*
	ufd 0.5 : Unobtrusive Fast-filter Drop-down jQuery plugin.

	Authors:
		thetoolman@gmail.com 
		Kadalashvili.Vladimir@gmail.com

	Version:  0.5

	Website: http://code.google.com/p/ufd/
 */

(function(g){g.widget("ui.ufd",{_init:function(){if(this.element[0].tagName.toLowerCase()!="select"){this.destroy();return false}this.options=g.extend(true,{},this.options);this.visibleCount=0;this.selectbox=this.element;this.logNode=g(this.options.logSelector);this.overflowCSS=this.options.allowLR?"overflow":"overflowY";var a=this.selectbox.attr("name"),b=a+this.options.suffix;a=this.options.submitFreeText?a:b;this.options.submitFreeText&&this.selectbox.attr("name",b);if(this.options.calculateZIndex)this.options.zIndexPopup=
this._calculateZIndex();this.css=b=this.options.css;this.options.useUiCss&&g.extend(this.css,this.options.uiCss);if(!b.skin)b.skin=this.options.skin;this.wrapper=g(['<span class="',b.wrapper," ",b.hidden," ",b.skin,'"><input type="text" autocomplete="off" value="" class="',b.input,'" name="',a,'"/><button type="button" tabindex="-1" class="',b.button,'"><div class="',b.buttonIcon,'"/></button></span>'].join(""));this.dropdown=g(['<div class="',b.skin,'"><div class="',b.listWrapper," ",b.hidden,'"><div class="',
b.listScroll,'"></div></div></div>'].join(""));this.selectbox.after(this.wrapper);this.getDropdownContainer().append(this.dropdown);this.input=this.wrapper.find("input");this.button=this.wrapper.find("button");this.listWrapper=this.dropdown.children(":first").css("z-index",this.options.zIndexPopup);this.listScroll=this.listWrapper.children(":first");g.fn.bgiframe&&this.listWrapper.bgiframe();this._populateFromMaster();this._initEvents()},_initEvents:function(){var a=this,b=g.ui.keyCode,c,d,f,h=this.options.css;
this.input.bind("keydown keypress keyup",function(e){d=e.type=="keypress";f=e.type=="keyup";c=null;if(undefined===e.which)c=e.keyCode;else if(!d&&e.which!=0)c=e.keyCode;else return;switch(c){case b.HOME:case b.END:if(a.options.homeEndForCursor)return;case b.DOWN:case b.PAGE_DOWN:case b.UP:case b.PAGE_UP:case b.ENTER:a.stopEvent(e);default:}if(!f!=(c!=b.TAB&&c!=b.ENTER)){a.lastKey=c;switch(c){case b.SHIFT:case b.CONTROL:break;case b.DOWN:a.selectNext(false);break;case b.PAGE_DOWN:a.selectNext(true);
break;case b.END:a.selectLast();break;case b.UP:a.selectPrev(false);break;case b.PAGE_UP:a.selectPrev(true);break;case b.HOME:a.selectFirst();break;case b.ENTER:a.hideList();a.tryToSetMaster();a.inputFocus();break;case b.TAB:a.realLooseFocusEvent();break;case b.ESCAPE:a.hideList();a.revertSelected();break;default:a.showList();a.filter(false,true);break}}});this.input.bind("click",function(e){if(a.isDisabled)a.stopEvent(e);else if(!a.listVisible()){a.filter(true);a.inputFocus();a.showList()}});this.input.bind("focus",
function(e){if(a.isDisabled)a.stopEvent(e);else a.internalFocus||a.realFocusEvent()});this.button.bind("mouseover",function(){a.button.addClass(h.buttonHover)});this.button.bind("mouseout",function(){a.button.removeClass(h.buttonHover)});this.button.bind("mousedown",function(){a.button.addClass(h.buttonMouseDown)});this.button.bind("mouseup",function(){a.button.removeClass(h.buttonMouseDown)});this.button.bind("click",function(e){if(a.isDisabled)a.stopEvent(e);else if(a.listVisible()){a.hideList();
a.inputFocus()}else{a.filter(true);a.inputFocus();a.showList()}});this.listScroll.bind("DOMMouseScroll mousewheel",function(e){a.stopEvent(e);e=e?e:window.event;e=e.detail?e.detail*-1:e.wheelDelta/40;e=a.listScroll.scrollTop()+(e>0?-1*a.itemHeight:1*a.itemHeight);a.listScroll.scrollTop(e)});this.listScroll.bind("mouseover mouseout click",function(e){if("LI"==e.target.nodeName.toUpperCase()){a.setActiveTimeout&&clearTimeout(a.setActiveTimeout);if("mouseout"==e.type){g(e.target).removeClass(h.liActive);
a.setActiveTimeout=setTimeout(function(){g(a.selectedLi).addClass(h.liActive)},a.options.delayYield)}else if("mouseover"==e.type){a.selectedLi!=e.target&&g(a.selectedLi).removeClass(h.liActive);g(e.target).addClass(h.liActive)}else{a.stopEvent(e);var j=g.trim(g(e.target).text());a.input.val(j);a.setActive(e.target);if(a.tryToSetMaster()){a.hideList();a.filter(true)}a.inputFocus()}}return true});this.selectbox.bind("change.ui.ufd",function(){if(a.isUpdatingMaster){a.isUpdatingMaster=false;return true}a.revertSelected()});
this._myDocClickHandler=function(e){a.button.get(0)==e.target||a.input.get(0)==e.target||a.internalFocus&&a.realLooseFocusEvent()};g(document).bind("click.ui.ufd",this._myDocClickHandler)},realFocusEvent:function(){this.internalFocus=true;this._triggerEventOnMaster("focus");this.wrapper.addClass(this.options.css.skin+"-"+this.options.css.inputFocus);this.input.addClass(this.options.css.inputFocus);this.button.addClass(this.options.css.inputFocus);this.filter(true);this.inputFocus();this.showList()},
realLooseFocusEvent:function(){this.internalFocus=false;this.hideList();this.wrapper.removeClass(this.options.css.skin+"-"+this.options.css.inputFocus);this.input.removeClass(this.options.css.inputFocus);this.button.removeClass(this.options.css.inputFocus);this.tryToSetMaster();this._triggerEventOnMaster("blur")},_triggerEventOnMaster:function(a){if(document.createEvent){var b=document.createEvent("HTMLEvents");b.initEvent(a,true,true);this.selectbox.get(0).dispatchEvent(b)}else document.createEventObject&&
this.selectbox.get(0).fireEvent("on"+a)},inputFocus:function(){this.input.focus();this.getCurrentTextValue().length&&this.selectAll()},inputBlur:function(){this.input.blur()},showList:function(){if(!this.listVisible()){this.listWrapper.removeClass(this.css.hidden);this.setListDisplay()}},hideList:function(){if(this.listVisible()){this.listWrapper.addClass(this.css.hidden);this.listItems.removeClass(this.css.hidden)}},filter:function(a,b){var c=this;this.updateOnTimeout&&clearTimeout(this.updateOnTimeout);
this.filterOnTimeout&&clearTimeout(this.filterOnTimeout);this.filterOnTimeout=this.updateOnTimeout=null;var d=c.getCurrentTextValue(),f=function(){var e=c.trie.find(d);c.trie.matches=e.matches;c.trie.misses=e.misses;c.updateOnTimeout=setTimeout(function(){h()},c.options.delayYield)},h=function(){var e=c.getActive();c.options.addEmphasis&&c.emphasis(c.trie.matches,true,d);c.overwriteClass(c.trie.matches,"");c.visibleCount=c.trie.matches.length;if(a||!c.trie.matches.length){c.overwriteClass(c.trie.misses,
"");c.visibleCount+=c.trie.misses.length;c.options.addEmphasis&&c.emphasis(c.trie.misses,false,d)}else c.overwriteClass(c.trie.misses,c.css.hidden);if(!e.hasClass(c.css.hidden)&&e.length&&c.trie.matches.length)c.setActive(e.get(0));else{e=c.listItems.filter(":visible:first");c.setActive(e.get(0))}c.setListDisplay()};if(b)this.filterOnTimeout=setTimeout(function(){f()},this.options.delayFilter);else f()},emphasis:function(a,b,c){var d=c.length||0,f=this.selectbox.get(0).options,h,e,j,k;h=a.length;
if(b=b&&d>0&&h>1){k=c.replace(/([\\\^\$*+[\]?{}.=!:(|)])/g,"\\$1");k=new RegExp("("+k+")","gi");this.hasEmphasis=true}for(;h--;){c=a[h];for(d=c.length;d--;){e=c[d];j=g.trim(f[e.getAttribute("name")].text);e.innerHTML=b?j.replace(k,"<em>$1</em>"):j}}},removeEmphasis:function(){if(this.hasEmphasis){this.hasEmphasis=false;for(var a=this.selectbox.get(0).options,b=this.list.get(0).getElementsByTagName("LI"),c=b.length,d;c--;){d=b[c];d.innerHTML=g.trim(a[d.getAttribute("name")].text)}}},tryToSetMaster:function(){var a=
null,b=this.getActive();if(b.length)a=b.attr("name");if(a==null||a==""||a<0){this.options.submitFreeText||this.revertSelected();return false}b=this.selectbox.get(0);var c=b.selectedIndex,d=b.options[a];if(!this.options.submitFreeText||this.input.val()==d.text){this.input.val(d.text);if(a!=c){this.isUpdatingMaster=true;b.selectedIndex=a;this._triggerEventOnMaster("change")}return true}return false},_populateFromMaster:function(){var a=!this.selectbox.filter("[disabled]").length;this.disable();this.setDimensions();
this.trie=new i(this.options.infix,this.options.caseSensitive);this.trie.matches=[];this.trie.misses=[];var b=this,c=[];c.push("<ul>");var d=this.selectbox.get(0).options,f,h,e;h=d.length;for(e=0;h--;){f=d[e++];c.push('<li name="');c.push(f.index);c.push('">');c.push(g.trim(f.text));c.push("</li>")}c.push("</ul>");this.listScroll.html(c.join(""));this.list=this.listScroll.find("ul:first");c=this.list.get(0).getElementsByTagName("LI");this.listItems=g(c);h=c.length;for(e=0;h--;){f=d[e];b.trie.add(g.trim(f.text),
c[e++])}this.visibleCount=c.length;this.setInputFromMaster();this.selectedLi=null;a&&this.enable()},setDimensions:function(){this.wrapper.addClass(this.css.hidden);if(this.selectIsWrapped&&(!this.options.manualWidth||this.options.unwrapForCSS)){this.wrapper.before(this.selectbox);this.selectIsWrapped=false}var a;if(this.options.manualWidth)a=this.options.manualWidth;else{a=this.selectbox.outerWidth();if(a<this.options.minWidth)a=this.options.minWidth;else if(this.options.maxWidth&&a>this.options.maxWidth)a=
this.options.maxWidth}var b=this.options.mimicCSS;for(propPtr in b){var c=b[propPtr];this.wrapper.css(c,this.selectbox.css(c))}if(!this.selectIsWrapped){this.wrapper.get(0).appendChild(this.selectbox.get(0));this.selectIsWrapped=true}this.wrapper.removeClass(this.css.hidden);this.listWrapper.removeClass(this.css.hidden);b=this.button.outerWidth(true);c=this.wrapper.outerWidth()-this.wrapper.width();var d=this.input.outerWidth(true)-this.input.width(),f=this.listScroll.outerWidth()-this.listScroll.width();
this.input.width(a-b-d);this.wrapper.width(a);this.listWrapper.width(a+c);this.listScroll.width(a+c-f);this.listWrapper.addClass(this.css.hidden)},setInputFromMaster:function(){var a=this.selectbox.get(0),b="";try{b=a.options[a.selectedIndex].text}catch(c){}this.input.val(b)},revertSelected:function(){this.setInputFromMaster();this.filter(true)},setListDisplay:function(){if(!this.itemHeight)this.itemHeight=this.listItems.filter("li:first").outerHeight(true);var a;if(this.visibleCount>this.options.listMaxVisible){a=
this.options.listMaxVisible*this.itemHeight;this.listScroll.css(this.overflowCSS,"scroll")}else{a=this.visibleCount*this.itemHeight;this.listScroll.css(this.overflowCSS,"hidden")}this.listScroll.height(a);var b=this.listScroll.outerHeight();this.listWrapper.height(b);var c=this.wrapper.offset(),d=this.wrapper.outerHeight(),f=c.top+d+b,h=g(window).height()+g(document).scrollTop(),e=c.left;if(f>h){this.listWrapper.addClass(this.css.listWrapperUp);b=c.top-b}else{this.listWrapper.removeClass(this.css.listWrapperUp);
b=c.top+d}this.listWrapper.css("left",e);this.listWrapper.css("top",b);this.scrollTo();return a},getActive:function(){if(this.selectedLi==null)return g([]);return g(this.selectedLi)},setActive:function(a){g(this.selectedLi).removeClass(this.css.liActive);this.selectedLi=a;g(this.selectedLi).addClass(this.css.liActive)},selectFirst:function(){this.afterSelect(this.listItems.filter(":not(.invisible):first"))},selectLast:function(){this.afterSelect(this.listItems.filter(":not(.invisible):last"))},selectPrev:function(a){this.afterSelect(this.searchRelativeVisible(false,
a?this.options.pageLength:1))},selectNext:function(a){this.afterSelect(this.searchRelativeVisible(true,a?this.options.pageLength:1))},afterSelect:function(a){if(a!=null){this.setActive(a);this.input.val(a.text());this.scrollTo();this.tryToSetMaster();this.inputFocus();this.removeEmphasis()}},searchRelativeVisible:function(a,b){var c=this.getActive();if(!c.length){this.selectFirst();return null}var d;do{d=c;do d=a?d.next():d.prev();while(d.length&&d.hasClass(this.css.hidden));if(d.length)c=d}while(--b);
return c},scrollTo:function(){if("scroll"!=this.listScroll.css(this.overflowCSS))return false;var a=this.getActive();if(!a.length)return false;var b=Math.floor(a.position().top);a=a.outerHeight(true);var c=this.listWrapper.height(),d=this.listScroll.scrollTop(),f=this.options.viewAhead*a;if(b<f)b=d+b-f;else if(b+a>=c-f)b=d+b-c+a+f;else return false;this.listScroll.scrollTop(b);return true},getCurrentTextValue:function(){return g.trim(this.input.val())},stopEvent:function(a){a=a?a:window.event;a.cancel=
true;a.cancelBubble=true;a.returnValue=false;a.stopPropagation&&a.stopPropagation();a.preventDefault&&a.preventDefault()},overwriteClass:function(a,b){var c,d,f;for(d=a.length;d--;){c=a[d];for(f=c.length;f--;)c[f].setAttribute(g.ui.ufd.classAttr,b)}},listVisible:function(){return!this.listWrapper.hasClass(this.css.hidden)},disable:function(){this.hideList();this.isDisabled=true;this.button.addClass(this.css.buttonDisabled);this.input.addClass(this.css.inputDisabled);this.input.attr("disabled","disabled");
this.selectbox.attr("disabled","disabled")},enable:function(){this.isDisabled=false;this.button.removeClass(this.css.buttonDisabled);this.input.removeClass(this.css.inputDisabled);this.input.removeAttr("disabled");this.selectbox.removeAttr("disabled")},selection:function(a,b,c){if(a.createTextRange){a=a.createTextRange();a.collapse(true);a.moveStart("character",b);a.moveEnd("character",c);a.select()}else if(a.setSelectionRange)a.setSelectionRange(b,c);else if(a.selectionStart){a.selectionStart=b;
a.selectionEnd=c}},selectAll:function(){this.input.get(0).select()},getDropdownContainer:function(){var a=g("#"+this.options.dropDownID);a.length||(a=g("<div></div>").appendTo("body").css("height",0).attr("id",this.options.dropDownID));return a},log:function(a){if(this.options.log){window.console&&window.console.log&&console.log(a);this.logNode&&this.logNode.length&&this.logNode.prepend("<div>"+a+"</div>")}},_calculateZIndex:function(){var a,b=this.options.zIndexPopup;this.selectbox.parents().each(function(){a=
parseInt(g(this).css("zIndex"),10);if(a>b)b=a});return b+1},changeOptions:function(){this._populateFromMaster()},destroy:function(){this.selectIsWrapped&&this.wrapper.before(this.selectbox);this.selectbox.unbind("change.ui.ufd");g(document).unbind("click.ui.ufd",this._myDocClickHandler);this.wrapper.remove();this.listWrapper.remove();if(g.ui.version<="1.7.2"){this.selectbox.unbind("setData.ui.ufd");this.selectbox.unbind("getData.ui.ufd");this.selectbox.unbind("remove")}g.widget.prototype.destroy.apply(this,
arguments);this.selectbox=null},selectIsWrapped:false,internalFocus:false,lastKey:null,selectedLi:null,isUpdatingMaster:false,hasEmphasis:false,isDisabled:false});var i=function(a,b){this.isInfix=!!a;this.isCaseSensitive=!!b;this.root=[null,{},false];this.infixRoots=a?{}:null};i.prototype.add=function(a,b){a=this.cleanString(a);for(var c=a.length,d=this.root,f,h=0;h<c;h++){f=a.charAt(h);d=d[1];if(f in d)d=d[f];else{d=d[f]=[null,{},this.root[2]];if(this.isInfix)if(f in this.infixRoots)this.infixRoots[f].push(d);
else this.infixRoots[f]=[d]}}if(d[0])d[0].push(b);else d[0]=[b];return true};i.prototype.find=function(a){a=this.findNodeArray(a);var b=!this.root[2],c=[],d=[],f;for(arrName in a){f=a[arrName];this.markAndRetrieve(c,f,b)}this.markAndRetrieve(d,this.root,b);return{matches:c,misses:d}};i.prototype.findNodeArray=function(a){a=this.cleanString(a);for(var b=[this.root],c=a.length,d,f=this.cache=this.cache||{},h=0;h<c;h++){d=a.charAt(h);if(f.chr==d)b=f.hit;else{b=this.mapNewArray(b,d);f.chr=d;f.hit=b;f.next=
{}}f=f.next}return b};i.prototype.mapNewArray=function(a,b){if(a.length&&a[0]==this.root)if(this.isInfix)return this.infixRoots[b]||[];else return(a=this.root[1][b])?[a]:[];for(var c=[],d=a.length,f,h=0;h<d;h++){f=a[h][1];f.hasOwnProperty(b)&&c.push(f[b])}return c};i.prototype.markAndRetrieve=function(a,b,c){for(b=[b];b.length>0;){var d=b.pop();if(d[2]!=c){d[2]=c;d[0]&&a.unshift(d[0]);for(chr in d[1])d[1].hasOwnProperty(chr)&&b.push(d[1][chr])}}};i.prototype.cleanString=function(a){this.isCaseSensitive||
(a=a.toLowerCase());return a};g.ui.ufd.getNewTrie=function(a,b){return new i(a,b)};g.extend(g.ui.ufd,{version:"0.5",getter:"",classAttr:g.support.style?"class":"className",defaults:{skin:"plain",suffix:"_ufd",dropDownID:"ufd-container",logSelector:"#log",mimicCSS:["marginLeft","marginTop","marginRight","marginBottom"],infix:true,addEmphasis:false,caseSensitive:false,submitFreeText:false,homeEndForCursor:false,allowLR:false,calculateZIndex:false,useUiCss:false,log:false,unwrapForCSS:false,listMaxVisible:10,
minWidth:50,maxWidth:null,manualWidth:null,viewAhead:1,pageLength:10,delayFilter:g.support.style?1:150,delayYield:1,zIndexPopup:101,css:{input:"",inputDisabled:"disabled",inputFocus:"focus",button:"",buttonIcon:"icon",buttonDisabled:"disabled",buttonHover:"hover",buttonMouseDown:"mouseDown",li:"",liActive:"active",hidden:"invisible",wrapper:"ufd",listWrapper:"list-wrapper",listWrapperUp:"list-wrapper-up",listScroll:"list-scroll"},uiCss:{skin:"uiCss",input:"ui-widget-content",inputDisabled:"disabled",
button:"ui-button",buttonIcon:"ui-icon ui-icon-triangle-1-s",buttonDisabled:"disabled",buttonHover:"ui-state-focus",buttonMouseDown:"ui-state-active",li:"ui-menu-item",liActive:"ui-state-hover",hidden:"invisible",wrapper:"ufd ui-widget ui-widget-content",listWrapper:"list-wrapper ui-widget ui-widget",listWrapperUp:"list-wrapper-up",listScroll:"list-scroll ui-widget-content"}}})})(jQuery);
