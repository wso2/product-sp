/***igviz.js***/!function(b){function c(a){var b=a.filter(function(a,b,c){return b==c.indexOf(a)});return b}function d(a,b,d,e,f){for(var g=[],h=[],i=[],j=0;j<a.data.length;j++)h[j]=a.data[j][b],i[j]=a.data[j][d];for(var k=c(i),l=c(h),m=[],j=0;j<l.length;j++){g[j]=[],m[j]=[],g[j][0]=l[j];for(var n=0;n<k.length;n++){switch(e){case"max":g[j][n+1]=Number.MIN_VALUE;break;case"min":g[j][n+1]=Number.MAX_VALUE;break;default:g[j][n+1]=0}m[j][n+1]=0}}var o,p;for(j=0;j<a.data.length;j++){var q=a.data[j][b],r=a.data[j][d],s=a.data[j][f];m[l.indexOf(q)][1+k.indexOf(r)]++,o=g[l.indexOf(q)][1+k.indexOf(r)],p=m[l.indexOf(q)][1+k.indexOf(r)];var t=0;switch(e){case"sum":t=o+s;break;case"min":t=o>s?s:o;break;case"max":t=s>o?s:o;break;case"avg":t=(o*(p-1)+s)/p;break;case"count":t=p}g[l.indexOf(q)][1+k.indexOf(r)]=t}var u={};for(u.metadata={},u.metadata.names=[],u.metadata.types=[],u.data=g,u.metadata.names[0]=a.metadata.names[b]+" \\ "+a.metadata.names[d],u.metadata.types[0]="C",j=0;j<k.length;j++)u.metadata.names[j+1]=k[j],u.metadata.types[j+1]="N";return console.log(u),u}function e(a,b,d){for(var e=[],f=[],g=[],h=0;h<a.data.length;h++)g[h]=a.data[h][b];for(var i=c(g),h=0;h<i.length;h++){e[h]=[],f[h]=0;for(var j=0;j<a.metadata.names.length;j++)if(b!=j)switch(d){case"max":e[h][j]=Number.MIN_VALUE;break;case"min":e[h][j]=Number.MAX_VALUE;break;default:e[h][j]=0}else e[h][j]=i[h]}for(h=0;h<a.data.length;h++){var k=a.data[h][b];f[i.indexOf(k)]++;var l=e[i.indexOf(k)],m=f[i.indexOf(k)];for(j=0;j<l.length;j++)if(j!=b){var n=l[j],o=a.data[h][j],p=0;switch(d){case"sum":p=n+o;break;case"min":p=n>o?o:n;break;case"max":p=o>n?o:n;break;case"avg":p=(n*(m-1)+o)/m;break;case"count":p=m}e[i.indexOf(k)][j]=p}}return console.log(e),e}function f(a){var b={name:a.name};console.log(a.schema,a.index);var c="table";if(b.range=a.range,void 0!=a.index)switch(a.schema.types[a.index]){case"T":b.type="time";break;case"U":b.type="utc";break;case"C":b.type="ordinal","c"===b.name&&(b.range="category20");break;case"N":b.type="linear"}else b.type=a.type;return a.hasOwnProperty("dataFrom")&&(c=a.dataFrom),b.range=a.range,b.domain={data:c,field:a.field},a.hasOwnProperty("round")&&(b.round=a.round),a.hasOwnProperty("nice")&&(b.nice=a.nice),a.hasOwnProperty("padding")&&(b.padding=a.padding),a.hasOwnProperty("reverse")&&(b.reverse=a.reverse),a.hasOwnProperty("sort")&&(b.sort=a.sort),"x"==b.name&&"linear"==b.type&&(b.sort=!0),a.hasOwnProperty("clamp")&&(b.clamp=a.clamp),a.hasOwnProperty("zero")&&(b.zero=a.zero),console.log(b),b}function g(a,b,c,d){return{type:"x",scale:"x",title:a,orient:d,values:[],properties:{title:{fill:{value:b},fontSize:{value:c}},axis:{strokeOpacity:{value:0}}}}}function h(a){console.log("Axis",a);var b={type:a.type,scale:a.scale,title:a.title,grid:a.grid,properties:{ticks:{},majorTicks:{strokeWidth:{value:2}},labels:{angle:{value:a.angle},align:{value:a.align},baseline:{value:"middle"},dx:{value:a.dx},dy:{value:a.dy}},title:{fontSize:{value:16},dx:{value:a.titleDx},dy:{value:a.titleDy}},axis:{stroke:{value:"#333"},strokeWidth:{value:1.5}}}};return a.hasOwnProperty("tickSize")&&(b.tickSize=a.tickSize),a.hasOwnProperty("tickPadding")&&(b.tickPadding=a.tickPadding),console.log("SpecAxis",b),b}function i(a,b){for(var c=[],d=0;d<a.length;d++){for(var e={},f=b.names,g=0;g<f.length;g++)"T"==b.types[g]?e[j(f[g])]=new Date(a[d][g]):"U"==b.types[g]?e[j(f[g])]=new Date(a[d][g]).getTime():e[j(f[g])]=a[d][g];c[d]=e}return console.log(c),c}function j(a){return a.replace(" ","_")}function k(a,b){var c={};c.tickSize="tickSize",c.tickPadding="tickPadding",c.title="title",c.grid="grid",c.offset="offset",c.ticks="ticks",c.labelColor="fill",c.labelAngle="angle",c.labelAlign="align",c.labelFontSize="fontSize",c.labelDx="dx",c.labelDy="dy",c.labelBaseLine="baseline",c.titleDx="dx",c.titleDy="dy",c.titleFontSize="fontSize",c.axisColor="stroke",c.axisWidth="strokeWidth",c.tickColor="stroke",c.tickWidth="strokeWidth",console.log("previous Axis",b);for(var d in a)"tickSize"!=d&&"tickPadding"!=d&&a.hasOwnProperty(d)&&(0==d.indexOf("label")?b.properties.labels[c[d]].value=a[d]:0==d.indexOf("ticks")?b.properties.ticks[c[d]].value=a[d]:0==d.indexOf("title")&&"title"!=d?b.properties.title[c[d]].value=a[d]:"title"==d?b.title=a[d]:0==d.indexOf("axis")?b.properties.axis[c[d]].value=a[d]:b[c[d]]=a[d]);console.log("NEW SPEC",b)}function l(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];var d=(b/a.length).toFixed(4);return d}function m(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d][b]);return c}function n(a,b,c){this.dataTable=c,this.config=b,this.canvas=a}function o(a,b){a.data.sort("U"==a.metadata.types[b]||"T"==a.metadata.types[b]?function(a,c){return new Date(a[b]).getTime()-new Date(c[b]).getTime()}:"C"==a.metadata.types[b]?function(a,c){return a[b].localeCompare(c[b])}:function(a,c){return a[b]-c[b]})}function p(a,b,c,d){var f=JSON.parse(JSON.stringify(a));void 0!=c&&(f.data=e(a,d,c));for(var g=-1,h=Number.NEGATIVE_INFINITY,i=0;i<b.length;i++){var k=d3.max(m(f.data,b[i]));console.log(m(f.data,b[i])),k>=h&&(g=i,h=k)}return void 0==c?"data."+j(a.metadata.names[b[g]]):"count"==c?"data."+c:"data."+c+"_"+j(a.metadata.names[b[g]])}window.igviz=b,b["var"]=20,b.draw=function(a,b,c){var d=new n(a,b,c);return"singleNumber"==b.chartType?d.diagram=this.drawSingleNumberDiagram(d):"map"==b.chartType?d.diagram=this.drawMap(a,b,c):"table"==b.chartType?d.diagram=this.drawTable(a,b,c):"arc"==b.chartType?d.diagram=this.drawArc(a,b,c):"drill"==b.chartType&&(d.diagram=this.drillDown(0,a,b,c,c)),d},b.setUp=function(a,b,c){var d;c.hasOwnProperty("metadata")||(d={metadata:c,data:[]},c=d);var e=new n(a,b,c);return"bar"==b.chartType?this.drawBarChart(e,a,b,c):"scatter"==b.chartType?this.drawScatterPlot(e):"line"==b.chartType?this.drawLineChart(e):"area"==b.chartType?this.drawAreaChart(e):"series"==b.chartType&&this.drawSeries(e),e},b.drawAggregatedArea=function(a){var b,c=a.config,d=a.dataTable,e="data."+j(d.metadata.names[c.xAxis]),i="sum";void 0!=c.aggregate&&(i=c.aggregate);var k,l=[];b="data."+j(d.metadata.names[c.yAxis]),k="data."+i+"_"+j(d.metadata.names[c.yAxis]),console.log("values",l,k,b),"count"==i&&(k="data.count");var m={index:c.xAxis,schema:d.metadata,name:"x",range:"width",round:!0,field:e,clamp:!1,dataFrom:"myTable"},n={type:"linear",name:"y",range:"height",nice:!0,field:k,dataFrom:"myTable"},o=f(m),p=f(n),q={type:"x",scale:"x",angle:-35,title:d.metadata.names[c.xAxis],grid:!1,dx:0,dy:0,align:"right",titleDy:30,titleDx:0},r={type:"y",scale:"y",angle:0,title:d.metadata.names[c.yAxis],grid:!0,dx:0,dy:0,align:"right",titleDy:-35,titleDx:0},s=h(q),t=h(r),u=g(c.title,"black",12,"top");void 0==c.interpolationMode&&(c.interpolationMode="monotone");var v={width:c.width-170,height:c.height,data:[{name:"table"},{name:"myTable",source:"table",transform:[{type:"aggregate",groupby:[e],fields:[{op:i,field:b}]}]}],scales:[o,p,{name:"color",type:"ordinal",range:"category10"}],axes:[s,t,u],marks:[{type:"area",key:e,from:{data:"myTable"},properties:{enter:{x:{scale:"x",field:e},interpolate:{value:c.interpolationMode},y:{scale:"y:prev",field:k},y2:{scale:"y:prev",value:0},fill:{scale:"color",value:d.metadata.names[c.yAxis]},fillOpacity:{value:.5}},update:{x:{scale:"x",field:e},y:{scale:"y",field:k},y2:{scale:"y",value:0}},hover:{fillOpacity:{value:.2}},exit:{x:{value:0},y:{scale:"y",field:k},y2:{scale:"y",value:0}}}},{type:"line",key:e,from:{data:"myTable"},properties:{enter:{x:{value:c.width-100},interpolate:{value:c.interpolationMode},y:{scale:"y:prev",field:k},stroke:{scale:"color",value:d.metadata.names[c.yAxis]},strokeWidth:{value:1.5}},update:{x:{scale:"x",field:e},y:{scale:"y",field:k}},exit:{x:{value:0},y:{scale:"y",field:k}}}},{type:"symbol",key:e,from:{data:"myTable"},properties:{enter:{x:{value:c.width-100},y:{scale:"y:prev",field:k},fill:{scale:"color",value:d.metadata.names[c.yAxis]}},update:{x:{scale:"x",field:e},y:{scale:"y",field:k}},exit:{x:{value:0},y:{scale:"y",field:k},fillOpacity:{value:0}}}}]};a.toolTipFunction=[],a.toolTipFunction[0]=function(b,e){console.log(tool,b,e),"symbol"==e.mark.marktype&&(xVar=d.metadata.names[c.xAxis],yVar=d.metadata.names[c.yAxis],contentString="<table><tr><td> X </td><td> ("+xVar+") </td><td>"+e.datum.data[xVar]+"</td></tr><tr><td> Y </td><td> ("+yVar+") </td><td>"+e.datum.data[yVar]+"</td></tr></table>",tool.html(contentString).style({left:b.pageX+10+"px",top:b.pageY+10+"px",opacity:1}),tool.selectAll("tr td").style("padding","3px")),a.toolTipFunction[1]=function(a){tool.html("").style({left:a.pageX+10+"px",top:a.pageY+10+"px",opacity:0})},a.toolTip=!0,a.spec=v}},b.drawAggregatedMultiArea=function(a){var b=a.config,c=a.dataTable,d="data."+j(c.metadata.names[b.xAxis]),e=[],i="sum";void 0!=b.aggregate&&(i=b.aggregate);var k=[],l=[];for(w=0;w<b.yAxis.length;w++)e[w]="data."+j(c.metadata.names[b.yAxis[w]]),k[w]="data."+i+"_"+j(c.metadata.names[b.yAxis[w]]),l.push({op:i,field:e[w]});console.log("values",l,k,e),"count"==i&&(k="data.count");var m={index:b.xAxis,schema:c.metadata,name:"x",range:"width",round:!0,field:d,clamp:!1,dataFrom:"myTable"},n={type:"linear",name:"y",range:"height",nice:!0,field:k[0],dataFrom:"myTable"},o=f(m),p=f(n),q={type:"x",scale:"x",angle:-35,title:c.metadata.names[b.xAxis],grid:!1,dx:0,dy:0,align:"right",titleDy:30,titleDx:0},r={type:"y",scale:"y",angle:0,title:"values",grid:!0,dx:0,dy:0,align:"right",titleDy:-35,titleDx:0},s=h(q),t=h(r),u=g(b.title,"black",12,"top");void 0==b.interpolationMode&&(b.interpolationMode="monotone");var v={width:b.width-170,height:b.height,data:[{name:"table"},{name:"myTable",source:"table",transform:[{type:"aggregate",groupby:[d],fields:l}]}],scales:[o,p,{name:"color",type:"ordinal",range:"category10"}],axes:[s,t,u],legends:[{orient:"right",fill:"color",title:"Legend",values:[],properties:{title:{fontSize:{value:14}},labels:{fontSize:{value:12}},symbols:{stroke:{value:"transparent"}},legend:{stroke:{value:"steelblue"},strokeWidth:{value:1.5}}}}],marks:[]};void 0==b.markerSize&&(b.markerSize=30);for(var w=0;w<b.yAxis.length;w++){var x={type:"area",key:d,from:{data:"myTable"},properties:{enter:{x:{scale:"x",field:d},interpolate:{value:b.interpolationMode},y:{scale:"y:prev",field:k[w]},y2:{scale:"y:prev",value:0},fill:{scale:"color",value:c.metadata.names[b.yAxis[w]]},fillOpacity:{value:.5}},update:{x:{scale:"x",field:d},y:{scale:"y",field:k[w]},y2:{scale:"y",value:0}},hover:{fillOpacity:{value:.2}},exit:{x:{value:0},y:{scale:"y",field:k[w]},y2:{scale:"y",value:0}}}},y={type:"line",key:d,from:{data:"myTable"},properties:{enter:{x:{value:b.width-100},interpolate:{value:b.interpolationMode},y:{scale:"y:prev",field:k[w]},stroke:{scale:"color",value:c.metadata.names[b.yAxis[w]]},strokeWidth:{value:1.5}},update:{x:{scale:"x",field:d},y:{scale:"y",field:k[w]}},exit:{x:{value:0},y:{scale:"y",field:k[w]}}}},z={type:"symbol",key:d,from:{data:"myTable"},properties:{enter:{x:{value:b.width-100},y:{scale:"y:prev",field:k[w]},fill:{scale:"color",value:c.metadata.names[b.yAxis[w]]},size:{value:b.markerSize}},update:{x:{scale:"x",field:d},y:{scale:"y",field:k[w]}},exit:{x:{value:0},y:{scale:"y",field:k[w]},fillOpacity:{value:0}}}};v.marks.push(x),v.marks.push(y),b.pointVisible&&v.marks.push(z),v.legends[0].values.push(c.metadata.names[b.yAxis[w]])}a.toolTipFunction=[],a.toolTipFunction[0]=function(a,d){if(console.log(tool,a,d),"symbol"==d.mark.marktype){for(var f=c.metadata.names[b.xAxis],g=d3.scale.category10(),h=-1,i=0;i<e.length;i++)if(d.fill===g(e[i])){h=i;break}var k=c.metadata.names[b.yAxis[h]];contentString="<table><tr><td> X </td><td> ("+f+") </td><td>"+d.datum.data[j(f)]+"</td></tr><tr><td> Y </td><td> ("+k+") </td><td>"+d.datum.data[b.aggregate+"_"+j(k)]+"</td></tr></table>",tool.html(contentString).style({left:a.pageX+10+"px",top:a.pageY+10+"px",opacity:1}),tool.selectAll("tr td").style("padding","3px")}},a.toolTipFunction[1]=function(a){tool.html("").style({left:a.pageX+10+"px",top:a.pageY+10+"px",opacity:0})},a.toolTip=!0,a.spec=v},b.drawAreaChart=function(a){var b=a.config,c=a.dataTable;if(b.yAxis.constructor===Array)return this.drawMultiAreaChart(a);if(void 0!=b.aggregate)return this.drawAggregatedArea(a);if(b.hasOwnProperty("areaVar"))return this.drawStackedAreaChart(a);var d="data."+j(c.metadata.names[b.xAxis]),e="data."+j(c.metadata.names[b.yAxis]),g={index:b.xAxis,schema:c.metadata,name:"x",range:"width",field:d},i={index:b.yAxis,schema:c.metadata,name:"y",range:"height",field:e},k=f(g),l=f(i),m={type:"x",scale:"x",angle:-35,title:c.metadata.names[b.xAxis],grid:!0,dx:-10,dy:10,align:"right",titleDy:10,titleDx:0},n={type:"y",scale:"y",angle:0,title:c.metadata.names[b.yAxis],grid:!0,dx:0,dy:0,align:"right",titleDy:-10,titleDx:0},o=h(m),p=h(n);void 0==b.interpolationMode&&(b.interpolationMode="monotone");var q=100,r={width:b.width-100,height:b.height,data:[{name:"table"}],scales:[k,l,{name:"color",type:"ordinal",range:"category10"}],axes:[o,p],marks:[{type:"area",key:d,from:{data:"table"},properties:{enter:{x:{value:b.width-q},interpolate:{value:b.interpolationMode},y:{scale:"y:prev",field:e},y2:{scale:"y:prev",value:0},fill:{scale:"color",value:2},fillOpacity:{value:.5}},update:{x:{scale:"x",field:d},y:{scale:"y",field:e},y2:{scale:"y",value:0}},exit:{x:{value:0},y:{scale:"y",field:e},y2:{scale:"y",value:0}},hover:{fillOpacity:{value:.2}}}},{type:"line",key:d,from:{data:"table"},properties:{enter:{x:{value:b.width-q},interpolate:{value:b.interpolationMode},y:{scale:"y:prev",field:e},stroke:{scale:"color",value:2},strokeWidth:{value:1.5}},update:{x:{scale:"x",field:d},y:{scale:"y",field:e}},exit:{x:{value:0},y:{scale:"y",field:e}}}}]};b.pointVisible&&(void 0==b.markerSize&&(b.markerSize=30),r.marks.push({type:"symbol",from:{data:"table"},properties:{enter:{x:{value:b.width-q},y:{scale:"y:prev",field:e},fill:{scale:"color",value:2},size:{value:b.markerSize}},update:{size:{value:50},x:{scale:"x",field:d},y:{scale:"y",field:e}},exit:{x:{value:0},y:{scale:"y",field:e}},hover:{size:{value:b.markerSize},stroke:{value:"white"}}}})),a.toolTipFunction=[],a.toolTipFunction[0]=function(a,d){console.log(tool,a,d),"symbol"==d.mark.marktype&&(xVar=c.metadata.names[b.xAxis],yVar=c.metadata.names[b.yAxis],contentString="<table><tr><td> X </td><td> ("+xVar+") </td><td>"+d.datum.data[j(xVar)]+"</td></tr><tr><td> Y </td><td> ("+yVar+") </td><td>"+d.datum.data[j(yVar)]+"</td></tr></table>",tool.html(contentString).style({left:a.pageX+10+"px",top:a.pageY+10+"px",opacity:1}),tool.selectAll("tr td").style("padding","3px"))},a.toolTipFunction[1]=function(a){tool.html("").style({left:a.pageX+10+"px",top:a.pageY+10+"px",opacity:0})},a.spec=r,a.toolTip=!0,a.spec=r},b.drawMultiAreaChart=function(c){var d=c.config,e=c.dataTable;if(void 0!=d.aggregate)return b.drawAggregatedMultiArea(c);for(var g="data."+j(e.metadata.names[d.xAxis]),i=[],k=0;k<d.yAxis.length;k++)i[k]="data."+j(e.metadata.names[d.yAxis[k]]);var l={index:d.xAxis,schema:e.metadata,name:"x",range:"width",clamp:!1,field:g},m={index:d.yAxis[0],schema:e.metadata,name:"y",range:"height",nice:!0,field:i[0]},n=f(l),o=f(m),p={type:"x",scale:"x",angle:-35,title:e.metadata.names[d.xAxis],grid:!0,dx:-10,dy:10,align:"left",titleDy:10,titleDx:0},q={type:"y",scale:"y",angle:0,title:"values",grid:!0,dx:0,dy:0,align:"right",titleDy:-10,titleDx:0},r=h(p),s=h(q);void 0==d.interpolationMode&&(d.interpolationMode="monotone");var t=160,u={width:d.width-t,height:d.height,data:[{name:"table"}],scales:[n,o,{name:"color",type:"ordinal",range:"category10"}],legends:[{orient:"right",fill:"color",title:"Area",values:[],properties:{title:{fontSize:{value:14}},labels:{fontSize:{value:12}},symbols:{stroke:{value:"transparent"}},legend:{stroke:{value:"steelblue"},strokeWidth:{value:1.5}}}}],axes:[r,s],marks:[]};for(void 0==d.markerSize&&(d.markerSize=30),k=0;k<d.yAxis.length;k++){var v={type:"area",key:g,from:{data:"table"},properties:{enter:{x:{scale:"x",field:g},interpolate:{value:d.interpolationMode},y:{scale:"y:prev",field:i[k]},y2:{scale:"y:prev",value:0},fill:{scale:"color",value:e.metadata.names[d.yAxis[k]]},fillOpacity:{value:.5}},update:{x:{scale:"x",field:g},y:{scale:"y",field:i[k]},y2:{scale:"y",value:0}},hover:{fillOpacity:{value:.2}},exit:{x:{value:0},y:{scale:"y",field:i[k]},y2:{scale:"y",value:0}}}},w={type:"line",key:g,from:{data:"table"},properties:{enter:{x:{scale:"x",field:g},interpolate:{value:d.interpolationMode},y:{scale:"y:prev",field:i[k]},stroke:{scale:"color",value:e.metadata.names[d.yAxis[k]]},strokeWidth:{value:1.5}},update:{x:{scale:"x",field:g},y:{scale:"y",field:i[k]}},exit:{x:{value:0},y:{scale:"y",field:i[k]}}}},x={type:"symbol",from:{data:"table"},properties:{enter:{x:{scale:"x",field:g},y:{scale:"y:prev",field:i[k]},fill:{scale:"color",value:e.metadata.names[d.yAxis[k]]},size:{value:d.markerSize}},update:{x:{scale:"x",field:g},y:{scale:"y",field:i[k]}},exit:{x:{value:0},y:{scale:"y",field:i[k]}},hover:{size:{value:1.5*d.markerSize},stroke:{value:"white"}}}};u.marks.push(v),d.pointVisible&&u.marks.push(x),u.marks.push(w),u.legends[0].values.push(e.metadata.names[d.yAxis[k]])}c.toolTipFunction=[],c.toolTipFunction[0]=function(b,c){if(a=4,console.log(tool,b,c),"symbol"==c.mark.marktype){for(var f=e.metadata.names[d.xAxis],g=d3.scale.category10(),h=-1,k=0;k<i.length;k++)if(c.fill===g(i[k])){h=k;break}var l=e.metadata.names[d.yAxis[h]];contentString="<table><tr><td> X </td><td> ("+f+") </td><td>"+c.datum.data[j(f)]+"</td></tr><tr><td> Y </td><td> ("+l+") </td><td>"+c.datum.data[j(l)]+"</td></tr></table>",tool.html(contentString).style({left:b.pageX+10+"px",top:b.pageY+10+"px",opacity:1}),tool.selectAll("tr td").style("padding","3px")}},c.toolTipFunction[1]=function(a){tool.html("").style({left:a.pageX+10+"px",top:a.pageY+10+"px",opacity:0})},c.spec=u,c.toolTip=!0,c.spec=u,c.spec=u},b.drawStackedAreaChart=function(a){var b=a.config,c=a.dataTable,d="data."+j(c.metadata.names[b.areaVar]),e="data."+j(c.metadata.names[b.yAxis]),g="data."+j(c.metadata.names[b.xAxis]),i={index:b.xAxis,schema:c.metadata,name:"cat",range:"width",field:g,padding:.2,zero:!1,nice:!0},k={index:b.yAxis,schema:c.metadata,name:"val",range:"height",dataFrom:"stats",field:"sum",nice:!0},l=f(i),m=f(k),n={type:"x",scale:"cat",angle:0,title:c.metadata.names[b.xAxis],grid:!0,dx:-10,dy:10,align:"left",titleDy:10,titleDx:0},o={type:"y",scale:"val",angle:0,title:c.metadata.names[b.yAxis],grid:!0,dx:0,dy:0,align:"right",titleDy:-10,titleDx:0},p=h(n),q=h(o);a.spec={width:b.width-160,height:b.height-100,padding:{top:10,left:60,bottom:60,right:100},data:[{name:"table"},{name:"stats",source:"table",transform:[{type:"facet",keys:[g]},{type:"stats",value:e}]}],scales:[l,m,{name:"color",type:"ordinal",range:"category20"}],legends:[{orient:{value:"right"},fill:"color",title:c.metadata.names[b.areaVar],values:[],properties:{title:{fontSize:{value:14}},labels:{fontSize:{value:12}},symbols:{stroke:{value:"transparent"}},legend:{stroke:{value:"steelblue"},strokeWidth:{value:.5}}}}],axes:[p,q],marks:[{type:"group",from:{data:"table",transform:[{type:"facet",keys:[d]},{type:"stack",point:g,height:e}]},marks:[{type:"area",properties:{enter:{interpolate:{value:"monotone"},x:{scale:"cat",field:g},y:{scale:"val",field:"y"},y2:{scale:"val",field:"y2"},fill:{scale:"color",field:d},fillOpacity:{value:.8}},update:{fillOpacity:{value:.8}},hover:{fillOpacity:{value:.5}}}},{type:"line",properties:{enter:{x:{scale:"cat",field:g},interpolate:{value:"monotone"},y:{scale:"val",field:"y"},stroke:{scale:"color",field:d},strokeWidth:{value:3}}}}]}]},a.legend=!0,a.legendIndex=b.areaVar},b.drawAggregatedBar=function(a){var b=a.config,c=a.dataTable,d="data."+j(c.metadata.names[b.xAxis]),e="data."+j(c.metadata.names[b.yAxis]),i="sum";void 0!=b.aggregate&&(i=b.aggregate);var k="data."+i+"_"+j(c.metadata.names[b.yAxis]);"count"==i&&(k="data.count"),console.log(d,e,k,i);var l={index:b.xAxis,schema:c.metadata,name:"x",range:"width",round:!0,field:d,dataFrom:"myTable"},m={type:"linear",name:"y",range:"height",nice:!0,field:k,dataFrom:"myTable"},n=f(l),o=f(m),p={type:"x",scale:"x",angle:-35,title:c.metadata.names[b.xAxis],grid:!1,dx:0,dy:0,align:"right",titleDy:30,titleDx:0},q={type:"y",scale:"y",angle:0,title:c.metadata.names[b.yAxis],grid:!0,dx:0,dy:0,align:"right",titleDy:-35,titleDx:0},r=h(p),s=h(q),t=g(b.title);void 0==b.barColor&&(b.barColor="steelblue"),a.spec={width:b.width-150,height:b.height,data:[{name:"table"},{name:"myTable",source:"table",transform:[{type:"aggregate",groupby:[d],fields:[{op:i,field:e}]}]}],scales:[n,o],axes:[r,s,t],marks:[{key:d,type:"rect",from:{data:"myTable"},properties:{enter:{x:{scale:"x",field:d},width:{scale:"x",band:!0,offset:-10},y:{scale:"y:prev",field:k},y2:{scale:"y",value:0}},update:{x:{scale:"x",field:d},y:{scale:"y",field:k},y2:{scale:"y",value:0},fill:{value:b.barColor}},exit:{x:{value:0},y:{scale:"y:prev",field:k},y2:{scale:"y",value:0}},hover:{fill:{value:"orange"}}}}]}},b.drawBarChart=function(a,b,c,d){var c=a.config,d=a.dataTable;if(c.hasOwnProperty("aggregate"))return this.drawAggregatedBar(a);if(c.hasOwnProperty("groupedBy")){var e="grouped";return c.hasOwnProperty("format")&&(e=c.format),"grouped"==e?"H"==c.orientation?(console.log("horizontal"),this.drawGroupedBarChart(a)):this.drawGroupedBarChartVertical(a):this.drawStackedBarChart(a)}var g="data."+j(d.metadata.names[c.xAxis]),i="data."+j(d.metadata.names[c.yAxis]),k={index:c.xAxis,schema:d.metadata,name:"x",range:"width",round:!0,field:g},l={index:c.yAxis,schema:d.metadata,name:"y",range:"height",nice:!0,field:i},m=f(k),n=f(l),o={type:"x",scale:"x",angle:-35,title:d.metadata.names[c.xAxis],grid:!1,dx:0,dy:0,align:"right",titleDy:30,titleDx:0},p={type:"y",scale:"y",angle:0,title:d.metadata.names[c.yAxis],grid:!0,dx:0,dy:0,align:"right",titleDy:-35,titleDx:0},q=h(o),r=h(p);void 0==c.barColor&&(c.barColor="steelblue");var s={width:c.width-150,height:c.height,data:[{name:"table"}],scales:[m,n],axes:[q,r],marks:[{key:g,type:"rect",from:{data:"table"},properties:{enter:{x:{scale:"x",field:g},width:{scale:"x",band:!0,offset:-10},y:{scale:"y:prev",field:i},y2:{scale:"y",value:0}},update:{x:{scale:"x",field:g},y:{scale:"y",field:i},y2:{scale:"y",value:0},fill:{value:c.barColor}},exit:{x:{value:0},y:{scale:"y:prev",field:i},y2:{scale:"y",value:0}},hover:{fill:{value:"orange"}}}}]};a.originalWidth=c.width,a.originalHeight=c.height,a.spec=s},b.drillDown=function(a,c,d,e,f){0==a&&(d3.select(c).append("div").attr({id:"links",height:20,bgcolor:"blue"}),d3.select(c).append("div").attr({id:"chartDiv"}),d.height=d.height-20,c="#chartDiv");var g=JSON.parse(JSON.stringify(d)),h=0;h=a<d.xAxis.length?d.xAxis[a].index:d.xAxis[a-1].child;for(var i,j,k,l=d.yAxis,m={metadata:{names:[e.metadata.names[h],e.metadata.names[l]],types:[e.metadata.types[h],e.metadata.types[l]]},data:[]},n=[],o=0;o<e.data.length;o++){i=e.data[o][h],j=e.data[o][l],k=!1;for(var p=0;p<n.length;p++)if(n[p][0]===i){k=!0;break}k?(n[p][1]+=j,console.log(i,j,n[p][1])):(console.log("create",i,j),n.push([i,j]))}m.data=n,g.xAxis=0,g.yAxis=1,g.chartType="bar";var q=this.setUp(c,g,m);q.plot(m.data,function(){d3.select("#links .root").on("click",function(){d3.select("#links").html(""),b.drillDown(0,c,d,f,f)});var g=d3.select("#links").selectAll(".filter");g.on("click",function(a,e){for(var h=g.data(),i=[],j=JSON.parse(JSON.stringify(f)),k=0,l=0;l<f.data.length;l++){for(var m=!0,n=0;e>=n;n++)if(f.data[l][h[n][0]]!==h[n][1]){m=!1;break}m&&(i[k++]=f.data[l])}d3.selectAll("#links g").each(function(a,b){b>e&&this.remove()}),j.data=i,b.drillDown(e+1,c,d,j,f,!0)}),a<d.xAxis.length&&(console.log(q),d3.select(q.chart._el).selectAll("g.type-rect rect").on("click",function(g,i){console.log(g,i,this),console.log(g,i);{var j=g.datum.data[q.dataTable.metadata.names[q.config.xAxis]],k=JSON.parse(JSON.stringify(e));d3.select("#links").append("g").append("text").text(e.metadata.names[h]+" : ").attr({"font-size":"10px",x:10,y:20})}d3.select("#links:first-child").selectAll("text").attr("class","root"),d3.select("#links g:last-child").append("span").data([[h,j]]).attr("class","filter").text(j+"  >  ");for(var l=k.data.length,m=[],n=0,o=0;l>o;o++)k.data[o][h]===j&&(m[n++]=k.data[o]);k.data=m,b.drillDown(a+1,c,d,k,f,!0)}))})},b.drawGroupedBarChart=function(a){var b=a.config,c=a.dataTable,d="data."+j(c.metadata.names[b.xAxis]),e="data."+j(c.metadata.names[b.yAxis]),g="data."+j(c.metadata.names[b.groupedBy]),i={index:b.groupedBy,schema:c.metadata,name:"cat",range:"height",field:g,padding:.2},k={index:b.yAxis,schema:c.metadata,name:"val",range:"width",round:"true",field:e,nice:!0},l=f(i),m=f(k),n={type:"x",scale:"val",angle:-35,title:c.metadata.names[b.yAxis],grid:!0,dx:-10,dy:10,align:"right",titleDy:10,titleDx:0},o={type:"y",scale:"cat",angle:0,tickSize:0,tickPadding:8,title:c.metadata.names[b.groupedBy],grid:!1,dx:0,dy:0,align:"right",titleDy:-10,titleDx:0},p=h(n),q=h(o),r={width:b.width,height:b.height,data:[{name:"table"}],scales:[l,m,{name:"color",type:"ordinal",range:"category20"}],axes:[p,q],legends:[{orient:{value:"right"},fill:"color",title:c.metadata.names[b.xAxis],values:[],properties:{title:{fontSize:{value:14}},labels:{fontSize:{value:12}},symbols:{stroke:{value:"transparent"}},legend:{stroke:{value:"steelblue"},strokeWidth:{value:.5}}}}],marks:[{type:"group",from:{data:"table",transform:[{type:"facet",keys:[g]}]},properties:{enter:{y:{scale:"cat",field:"key"},height:{scale:"cat",band:!0}}},scales:[{name:"pos",type:"ordinal",range:"height",domain:{field:d}}],marks:[{type:"rect",properties:{enter:{y:{scale:"pos",field:d},height:{scale:"pos",band:!0},x:{scale:"val",field:e},x2:{scale:"val",value:0},fill:{scale:"color",field:d}},hover:{fillOpacity:{value:.5}},update:{fillOpacity:{value:1}}}}]}]};a.legend=!0,a.legendIndex=b.xAxis,a.spec=r},b.drawGroupedBarChartVertical=function(a){var b=a.config,c=a.dataTable,d="data."+j(c.metadata.names[b.xAxis]),e="data."+j(c.metadata.names[b.yAxis]),g="data."+j(c.metadata.names[b.groupedBy]),i={index:b.groupedBy,schema:c.metadata,name:"cat",range:"width",field:g,padding:.2},k={index:b.yAxis,schema:c.metadata,name:"val",range:"height",round:"true",field:e,nice:!0},l=f(i),m=f(k),n={type:"y",scale:"val",angle:-35,title:c.metadata.names[b.yAxis],grid:!0,dx:-10,dy:10,align:"right",titleDy:10,titleDx:0},o={type:"x",scale:"cat",angle:0,tickSize:0,tickPadding:8,title:c.metadata.names[b.groupedBy],grid:!1,dx:0,dy:0,align:"right",titleDy:-10,titleDx:0},p=h(o),q=h(n),r={width:b.width-150,height:b.height,data:[{name:"table"}],scales:[l,m,{name:"color",type:"ordinal",range:"category20"}],axes:[p,q],legends:[{orient:{value:"right"},fill:"color",title:c.metadata.names[b.xAxis],values:[],properties:{title:{fontSize:{value:14}},labels:{fontSize:{value:12}},symbols:{stroke:{value:"transparent"}},legend:{stroke:{value:"steelblue"},strokeWidth:{value:.5}}}}],marks:[{type:"group",from:{data:"table",transform:[{type:"facet",keys:[g]}]},properties:{enter:{x:{scale:"cat",field:"key"},width:{scale:"cat",band:!0}}},scales:[{name:"pos",type:"ordinal",range:"width",domain:{field:d}}],marks:[{type:"rect",properties:{enter:{x:{scale:"pos",field:d},width:{scale:"pos",band:!0},y:{scale:"val",field:e},y2:{scale:"val",value:0},fill:{scale:"color",field:d}},hover:{fillOpacity:{value:.5}},update:{fillOpacity:{value:1}}}}]}]};a.legend=!0,a.legendIndex=b.xAxis,a.spec=r},b.drawStackedBarChart=function(a){var b=a.config,c=a.dataTable,d="data."+j(c.metadata.names[b.xAxis]),e="data."+j(c.metadata.names[b.yAxis]),g="data."+j(c.metadata.names[b.groupedBy]),i={index:b.groupedBy,schema:c.metadata,name:"cat",range:"width",field:g,padding:.2},k={index:b.yAxis,schema:c.metadata,name:"val",range:"height",dataFrom:"stats",field:"sum",nice:!0},l=f(i),m=f(k),n={type:"x",scale:"cat",angle:0,title:c.metadata.names[b.groupedBy],grid:!1,dx:-10,dy:10,align:"right",titleDy:10,titleDx:0},o={type:"y",scale:"val",angle:0,title:c.metadata.names[b.yAxis],grid:!1,dx:0,dy:0,align:"right",titleDy:-10,titleDx:0},p=h(n),q=h(o),r={width:b.width-160,height:b.height-100,padding:{top:10,left:60,bottom:60,right:100},data:[{name:"table"},{name:"stats",source:"table",transform:[{type:"facet",keys:[g]},{type:"stats",value:e}]}],scales:[l,m,{name:"color",type:"ordinal",range:"category20"}],legends:[{orient:{value:"right"},fill:"color",title:c.metadata.names[b.xAxis],values:[],properties:{title:{fontSize:{value:14}},labels:{fontSize:{value:12}},symbols:{stroke:{value:"transparent"}},legend:{stroke:{value:"steelblue"},strokeWidth:{value:.5}}}}],axes:[p,q],marks:[{type:"group",from:{data:"table",transform:[{type:"facet",keys:[d]},{type:"stack",point:g,height:e}]},marks:[{type:"rect",properties:{enter:{x:{scale:"cat",field:g},width:{scale:"cat",band:!0,offset:-1},y:{scale:"val",field:"y"},y2:{scale:"val",field:"y2"},fill:{scale:"color",field:d}},update:{fillOpacity:{value:1}},hover:{fillOpacity:{value:.5}}}}]}]};a.legend=!0,a.legendIndex=b.xAxis,a.spec=r},b.drawArc=function(a,b,c){function d(a){function c(){function a(a){"function"==typeof j&&j.call()}h.each(function(c){function h(a){var b=(q-r)/(s-r),c=Math.min(360*b,360);c=c*Math.PI/180,y.datum(c),y.transition().duration(k).attrTween("d",e),b>1&&(z.datum(Math.min(360*(b-1),360)*Math.PI/180),z.transition().delay(k).duration(k).attrTween("d",f)),A.datum(Math.round(100*b)),A.transition().duration(k).tween("text",d)}var i=d3.select(this).selectAll("svg").data([c]),j=i.enter().append("svg").attr("class","radial-svg").append("g");g(),i.attr("width",m).attr("height",n);var l=j.append("g").attr("class","component").attr("cursor","pointer").on("click",a);w.endAngle(360*(Math.PI/180)),l.append("rect").attr("class","background").attr("width",_width).attr("height",_height),l.append("path").attr("transform","translate("+_width/2+","+_width/2+")").attr("d",w),l.append("text").attr("class","label").attr("transform","translate("+_width/2+","+(_width+p)+")").text(o);{var u=b.width/2-_width/2,v=b.height/2-_height/2;i.select("g").attr("transform","translate("+u+","+v+")")}w.endAngle(t),j.append("g").attr("class","arcs");var y=i.select(".arcs").selectAll(".arc").data(c);y.enter().append("path").attr("class","arc").attr("transform","translate("+_width/2+","+_width/2+")").attr("d",w);var z=i.select(".arcs").selectAll(".arc2").data(c);z.enter().append("path").attr("class","arc2").attr("transform","translate("+_width/2+","+_width/2+")").attr("d",x),j.append("g").attr("class","labels");var A=i.select(".labels").selectAll(".label").data(c);A.enter().append("text").attr("class","label").attr("y",_width/2+p/3).attr("x",_width/2).attr("cursor","pointer").attr("width",_width).text(function(a){return Math.round((q-r)/(s-r)*100)+"%"}).style("font-size",p+"px").on("click",a),y.exit().transition().duration(500).attr("x",1e3).remove(),h(i)})}function d(a){var b=d3.interpolate(v,a);return v=b(0),function(a){v=b(a),this.textContent=Math.round(b(a))+"%"}}function e(a){var b=d3.interpolate(t,a);return function(a){return t=b(a),w.endAngle(b(a))()}}function f(a){var b=d3.interpolate(u,a);return function(a){return x.endAngle(b(a))()}}function g(){_width=i-l.right-l.left-l.top-l.bottom,_height=_width,p=.2*_width,w.outerRadius(_width/2),w.innerRadius(_width/2*.85),x.outerRadius(_width/2*.85),x.innerRadius(_width/2*.85-_width/2*.15)}var h,i,j,k=1e3,l={top:0,right:0,bottom:30,left:0},m=b.width,n=b.height,o="",p=10,q=0,r=0,s=100,t=0,u=0,v=0,w=d3.svg.arc().startAngle(0),x=d3.svg.arc().startAngle(0).endAngle(0);return h=d3.select(a),c.render=function(){return g(),c(),c},c.value=function(a){return arguments.length?(q=[a],h.datum([q]),c):q},c.margin=function(a){return arguments.length?(l=a,c):l},c.diameter=function(a){return arguments.length?(i=a,c):i},c.minValue=function(a){return arguments.length?(r=a,c):r},c.maxValue=function(a){return arguments.length?(s=a,c):s},c.label=function(a){return arguments.length?(o=a,c):o},c._duration=function(a){return arguments.length?(k=a,c):k},c.onClick=function(a){return arguments.length?(j=a,c):j},c}d(a).label("RADIAL 1").diameter(b.diameter).value(b.value).render()},b.drawAggregatedLine=function(a){var b=a.config,c=a.dataTable,d="data."+j(c.metadata.names[b.xAxis]),e=[],i="sum";

void 0!=b.aggregate&&(i=b.aggregate);for(var k=[],l=[],m=0;m<b.yAxis.length;m++)e[m]="data."+j(c.metadata.names[b.yAxis[m]]),k[m]="data."+i+"_"+j(c.metadata.names[b.yAxis[m]]),l.push({op:i,field:e[m]});console.log("values",l,k,e),"count"==i&&(k="data.count");var n={index:b.xAxis,schema:c.metadata,name:"x",range:"width",round:!0,field:d,clamp:!1,dataFrom:"myTable"},o={type:"linear",name:"y",range:"height",nice:!0,field:k[0],dataFrom:"myTable"},p=f(n),q=f(o),r={type:"x",scale:"x",angle:-35,title:c.metadata.names[b.xAxis],grid:!1,dx:0,dy:0,align:"right",titleDy:30,titleDx:0},s={type:"y",scale:"y",angle:0,title:"values",grid:!0,dx:0,dy:0,align:"right",titleDy:-35,titleDx:0},t=h(r),u=h(s),v=g(b.title,"black",12,"top");void 0==b.interpolationMode&&(b.interpolationMode="monotone");var w={width:b.width-150,height:b.height,data:[{name:"table"},{name:"myTable",source:"table",transform:[{type:"aggregate",groupby:[d],fields:l}]}],scales:[p,q,{name:"color",type:"ordinal",range:"category10"}],axes:[t,u,v],legends:[{orient:"right",fill:"color",title:"Legend",values:[],properties:{title:{fontSize:{value:14}},labels:{fontSize:{value:12}},symbols:{stroke:{value:"transparent"}},legend:{stroke:{value:"steelblue"},strokeWidth:{value:1.5}}}}],marks:[]};for(void 0==b.markerSize&&(b.markerSize=30),m=0;m<b.yAxis.length;m++){var x={type:"line",key:d,from:{data:"myTable"},properties:{enter:{x:{value:b.width-100},interpolate:{value:b.interpolationMode},y:{scale:"y:prev",field:k[m]},stroke:{scale:"color",value:c.metadata.names[b.yAxis[m]]},strokeWidth:{value:1.5}},update:{x:{scale:"x",field:d},y:{scale:"y",field:k[m]}},exit:{x:{value:0},y:{scale:"y",field:k[m]}}}},y={type:"symbol",key:d,from:{data:"myTable"},properties:{enter:{x:{value:b.width-100},y:{scale:"y:prev",field:k[m]},fill:{scale:"color",value:c.metadata.names[b.yAxis[m]]},size:{value:b.markerSize}},update:{x:{scale:"x",field:d},y:{scale:"y",field:k[m]}},exit:{x:{value:0},y:{scale:"y",field:k[m]},fillOpacity:{value:0}}}};w.marks.push(x),b.pointVisible&&w.marks.push(y),w.legends[0].values.push(c.metadata.names[b.yAxis[m]])}a.toolTipFunction=[],a.toolTipFunction[0]=function(a,d){if(console.log(tool,a,d),"symbol"==d.mark.marktype){for(var f=c.metadata.names[b.xAxis],g=d3.scale.category10(),h=-1,i=0;i<e.length;i++)if(d.fill===g(e[i])){h=i;break}var k=c.metadata.names[b.yAxis[h]],l=j(k),m="<table><tr><td> X </td><td> ("+f+") </td><td>"+d.datum.data[f]+"</td></tr><tr><td> Y </td><td> ("+k+") </td><td>"+d.datum.data[b.aggregate+"_"+l]+"</td></tr></table>";tool.html(m).style({left:a.pageX+10+"px",top:a.pageY+10+"px",opacity:1}),tool.selectAll("tr td").style("padding","3px")}},a.toolTipFunction[1]=function(a,b){tool.html("").style({left:a.pageX+10+"px",top:a.pageY+10+"px",opacity:0})},a.toolTip=!0,a.spec=w},b.drawLineChart=function(a){var c=a.config,d=a.dataTable;if(void 0!=c.aggregate)return b.drawAggregatedLine(a);for(var e="data."+j(d.metadata.names[c.xAxis]),g=[],i=0;i<c.yAxis.length;i++)g[i]="data."+j(d.metadata.names[c.yAxis[i]]);var k={index:c.xAxis,schema:d.metadata,name:"x",range:"width",clamp:!1,field:e},l={index:c.yAxis[0],schema:d.metadata,name:"y",range:"height",nice:!0,field:g[0]},m=f(k),n=f(l),o={type:"x",scale:"x",angle:-35,title:d.metadata.names[c.xAxis],grid:!0,dx:-10,dy:10,align:"right",titleDy:10,titleDx:0},p={type:"y",scale:"y",angle:0,title:"values",grid:!0,dx:0,dy:0,align:"right",titleDy:-10,titleDx:0},q=h(o),r=h(p);void 0==c.interpolationMode&&(c.interpolationMode="monotone");var s=160,t={width:c.width-s,height:c.height,data:[{name:"table"}],scales:[m,n,{name:"color",type:"ordinal",range:"category10"}],axes:[q,r],legends:[{orient:"right",fill:"color",title:"Legend",values:[],properties:{title:{fontSize:{value:14}},labels:{fontSize:{value:12}},symbols:{stroke:{value:"transparent"}},legend:{stroke:{value:"steelblue"},strokeWidth:{value:1.5}}}}],marks:[]};for(void 0==c.markerSize&&(c.markerSize=30),i=0;i<c.yAxis.length;i++){var u={type:"line",key:e,from:{data:"table"},properties:{enter:{x:{value:c.width-s},interpolate:{value:c.interpolationMode},y:{scale:"y:prev",field:g[i]},stroke:{scale:"color",value:d.metadata.names[c.yAxis[i]]},strokeWidth:{value:1.5}},update:{x:{scale:"x",field:e},y:{scale:"y",field:g[i]}},exit:{x:{value:0},y:{scale:"y",field:g[i]}}}},v={type:"symbol",key:e,from:{data:"table"},properties:{enter:{" x":{value:c.width-s},y:{scale:"y:prev",field:g[i]},fill:{scale:"color",value:d.metadata.names[c.yAxis[i]]},size:{value:c.markerSize}},update:{x:{scale:"x",field:e},y:{scale:"y",field:g[i]}},exit:{x:{value:0},y:{scale:"y",field:g[i]},fillOpacity:{value:0}}}};t.marks.push(u),c.pointVisible&&t.marks.push(v),t.legends[0].values.push(d.metadata.names[c.yAxis[i]])}a.toolTipFunction=[],a.toolTipFunction[0]=function(a,b){if("symbol"==b.mark.marktype){for(var e=d.metadata.names[c.xAxis],f=d3.scale.category10(),h=-1,i=0;i<g.length;i++)if(b.fill===f(g[i])){h=i;break}var k=d.metadata.names[c.yAxis[h]],l=j(k),m="<table><tr><td> X </td><td> ("+e+") </td><td>"+b.datum.data[j(e)]+"</td></tr><tr><td> Y </td><td> ("+k+") </td><td>"+b.datum.data[l]+"</td></tr></table>";tool.html(m).style({left:a.pageX+10+"px",top:a.pageY+10+"px",opacity:1}),tool.selectAll("tr td").style("padding","3px")}},a.toolTipFunction[1]=function(a,b){tool.html("").style({left:a.pageX+10+"px",top:a.pageY+10+"px",opacity:0})},a.spec=t,a.toolTip=!0,a.spec=t},b.drawMap=function(a,b,c){function d(a,b){("satellite"==i||"terrain"==i||"normal"==i)&&e(a),("regions"==i||"markers"==i)&&f(b)}function e(b){var c=google.visualization.arrayToDataTable(b),d={showTip:!0,useMapTypeControl:!0,mapType:i},e=new google.visualization.Map(document.getElementById(a));e.draw(c,d)}function f(b){console.log(google),console.log(google.visualization);var c=google.visualization.arrayToDataTable(b),d={region:j,displayMode:i,colorAxis:{colors:["red","blue"]},magnifyingGlass:{enable:!0,zoomFactor:3},enableRegionInteractivity:!0},e=new google.visualization.GeoChart(document.getElementById(a));e.draw(c,d)}var a=a.substr(1),g=b.width,h=b.height,i=b.mode,j=b.region,k=c.data.map(function(a,d){return{data:a,config:b,name:c.metadata.names[d]}}),l=[],m=[],n=k[0].config.mapLocation,o=k[0].config.pointColor,p=k[0].config.pointSize;l.push(k[n].name,k[o].name,k[p].name),m.push(l);for(var q=0;q<k.length;q++)l=[],l.push(k[q].data[n],k[q].data[o],k[q].data[p]),m.push(l);for(var r=[],s=0;s<m.length;s++){for(var t=m[s],u="",v=1;v<t.length;v++)u+=m[0][v]+":"+t[v]+" , ";u=u.substring(0,u.length-3),u=m[s][0].toUpperCase()+"\n"+u,l=[],l.push(m[s][0]),l.push(u),r.push(l)}document.getElementById(a).setAttribute("style","width: "+g+"px; height: "+h+"px;"),d(r,m)},b.drawScatterPlot=function(a){var b=a.config,c=a.dataTable,d="data."+j(c.metadata.names[b.xAxis]),e="data."+j(c.metadata.names[b.yAxis]),g="data."+j(c.metadata.names[b.pointSize]),i="data."+j(c.metadata.names[b.pointColor]),k={index:b.xAxis,schema:c.metadata,name:"x",range:"width",field:d},l={index:b.pointSize,range:[0,576],schema:c.metadata,name:"r",field:g},m={index:b.pointColor,schema:c.metadata,name:"c",range:[b.minColor,b.maxColor],field:i},n={index:b.yAxis,schema:c.metadata,name:"y",range:"height",nice:!0,field:e},o=f(k),p=f(n),q=f(l),r=f(m),s={type:"x",scale:"x",angle:-35,title:c.metadata.names[b.xAxis],grid:!0,dx:0,dy:0,align:"right",titleDy:25,titleDx:0},t={type:"y",scale:"y",angle:0,title:"values",grid:!0,dx:0,dy:0,align:"right",titleDy:-30,titleDx:0},u=h(s),v=h(t),w={width:b.width-130,height:b.height,data:[{name:"table"}],scales:[o,p,{name:"color",type:"ordinal",range:"category20"},q,r],axes:[u,v],marks:[{type:"symbol",from:{data:"table"},properties:{enter:{x:{scale:"x",field:d},y:{scale:"y",field:e},fill:{scale:"c",field:i}},update:{size:{scale:"r",field:g}},hover:{size:{value:300},stroke:{value:"white"}}}}]};a.toolTipFunction=[],a.toolTipFunction[0]=function(a,d){console.log(tool,a,d),xVar=c.metadata.names[b.xAxis],yVar=c.metadata.names[b.yAxis],pSize=c.metadata.names[b.pointSize],pColor=c.metadata.names[b.pointColor],contentString="<table><tr><td> X </td><td> ("+xVar+") </td><td>"+d.datum.data[xVar]+"</td></tr><tr><td> Y </td><td> ("+yVar+") </td><td>"+d.datum.data[yVar]+"</td></tr><tr><td> Size </td><td> ("+pSize+") </td><td>"+d.datum.data[pSize]+'</td></tr><tr><td bgcolor="'+d.fill+'">&nbsp; </td><td> ('+pColor+") </td><td>"+d.datum.data[pColor]+"</td></tr></table>",tool.html(contentString).style({left:a.pageX+10+"px",top:a.pageY+10+"px",opacity:1}),tool.selectAll("tr td").style("padding","3px")},a.toolTipFunction[1]=function(a){tool.html("").style({left:a.pageX+10+"px",top:a.pageY+10+"px",opacity:0})},a.spec=w,a.toolTip=!0},b.drawSeries=function(a){for(var b=a.config,c=a.dataTable,d="data."+j(c.metadata.names[b.xAxis]),e=[],g=0;g<b.yAxis.length;g++)e[g]="data."+j(c.metadata.names[b.yAxis[g]]);var i={index:b.xAxis,schema:c.metadata,name:"x",range:"width",clamp:!1,field:d},k={index:b.yAxis[0],schema:c.metadata,name:"y",range:"height",nice:!0,field:e[0]},l=f(i),m=f(k),n={type:"x",scale:"x",angle:-35,title:c.metadata.names[b.xAxis],grid:!0,dx:-10,dy:10,align:"right",titleDy:10,titleDx:0},o={type:"y",scale:"y",angle:0,title:"values",grid:!0,dx:0,dy:0,align:"right",titleDy:-10,titleDx:0},p=h(n),q=h(o),r=160,s={width:b.width-r,height:b.height,data:[{name:"table"}],scales:[l,m,{name:"color",type:"ordinal",range:"category20"}],axes:[p,q],legends:[{orient:"right",fill:"color",title:"Legend",values:[],properties:{title:{fontSize:{value:14}},labels:{fontSize:{value:12}},symbols:{stroke:{value:"transparent"}},legend:{stroke:{value:"steelblue"},strokeWidth:{value:1.5}}}}],marks:[]};for(g=0;g<b.yAxis.length;g++){var t={type:"rect",key:d,from:{data:"table"},properties:{enter:{x:{scale:"x",field:d},y:{scale:"y",field:e[g]},y2:{scale:"y",value:0},width:{value:2},fill:{scale:"color",value:c.metadata.names[b.yAxis[g]]}}}},u={type:"symbol",key:d,from:{data:"table"},properties:{enter:{" x":{value:b.width-r},y:{scale:"y:prev",field:e[g]},fill:{scale:"color",value:c.metadata.names[b.yAxis[g]]}},update:{x:{scale:"x",field:d},y:{scale:"y",field:e[g]}},exit:{x:{value:0},y:{scale:"y",field:e[g]},fillOpacity:{value:0}}}};b.lineMark&&s.marks.push(t),b.pointMark&&s.marks.push(u),s.legends[0].values.push(c.metadata.names[b.yAxis[g]])}a.spec=s},b.drawSingleNumberDiagram=function(a){var c=a.canvas,d=a.config,e=a.dataTable,f=d.width,g=d.height,h=f/25,i=f/18,j=f/25,k="minValue",n="maxValue",o="avgValue",d={xAxis:d.xAxis,yAxis:1,aggregate:"sum",chartType:"bar",width:600,height:3*g/4},p=b.setUp(c,d,e);p.plot(e.data);var q=e.data.map(function(a){return{data:a,config:d}}),r=c+"_svg";d3.select(r).remove();var s=d3.select(c).append("svg").attr("id",r.replace("#","")).attr("width",f).attr("height",g),t=e.data,u=m(t,q[0].config.xAxis),v=s.append("g");s.append("rect").attr("id","rect").attr("x",0).attr("y",0).attr("width",f).attr("height",g),v.append("text").attr("id",k).text("Max: "+d3.max(u)).attr("font-size",j).attr("x",3*f/4).attr("y",6*g/7).style("fill","Red").style("text-anchor","start").style("lignment-baseline","middle"),v.append("text").attr("id",o).text("Avg :"+l(u)).attr("font-size",i).attr("x",f/2).attr("y",6*g/7).style("fill","Green").style("text-anchor","middle").style("lignment-baseline","middle"),v.append("text").attr("id",n).text("Min: "+d3.min(u)).attr("font-size",h).attr("x",f/4).attr("y",6*g/7).style("fill","Black").style("text-anchor","end").style("lignment-baseline","middle")},b.drawTable=function(a,b,c){b.width,b.height,b.padding,b.dataSeries,b.highlightMode;void 0!=b.rowIndex&&void 0!=b.columnIndex?c=d(c,b.rowIndex,b.columnIndex,b.aggregate,b.cellIndex):void 0!=b.aggregate&&(c=e(c,b.groupedBy,b.aggregate));c.data.map(function(a){return{data:a,config:b}});d3.select(a).select("table").remove();var f=c.metadata.names,g=c.data,h=[{r:255,g:0,b:0},{r:0,g:255,b:0},{r:200,g:100,b:100},{r:200,g:255,b:250},{r:255,g:140,b:100},{r:230,g:100,b:250},{r:0,g:138,b:230},{r:165,g:42,b:42},{r:127,g:0,b:255},{r:0,g:255,b:255}],i=d3.scale.linear().domain([0,100]).range([0,1]),j=d3.select(a).append("table").attr("class","table table-bordered"),k=d3.scale.linear().domain([2.5,4]).range(["#F5BFE8","#E305AF"]),l=d3.scale.linear().domain([0,100]).range([15,20]),n=j.append("thead"),o=j.append("tbody");n.append("tr").selectAll("th").data(f).enter().append("th").text(function(a){return a});var p,q=b.colorBasedStyle,r=b.fontBasedStyle,s=o.selectAll("tr").data(g).enter().append("tr");if(b.heatMap){for(var t=c.data[0][1],u=c.data[0][1],v=0;v<c.data.length;v++)for(var w=0;w<c.metadata.names.length;w++)"N"==c.metadata.types[w]&&(c.data[v][w]>u&&(u=c.data[v][w]),c.data[v][w]<t&&(t=c.data[v][w]));i.domain([t,u]),p=s.selectAll("td").data(function(a,b){return console.log(a,b),a}).enter().append("td").text(function(a,b){return a}).style("background-color",function(a,b){return"rgba("+h[0].r+","+h[0].g+","+h[0].b+","+i(a)+")"})}else 1==q&&1==r?p=s.selectAll("td").data(function(a,b){return a}).enter().append("td").text(function(a,b){return a}).style("font-size",function(a,b){return l.domain([d3.min(m(g,b)),d3.max(m(g,b))]),l(a)+"px"}).style("background-color",function(a,b){return i.domain([d3.min(m(g,b)),d3.max(m(g,b))]),"rgba("+h[b].r+","+h[b].g+","+h[b].b+","+i(a)+")"}):q&&!r?p=s.selectAll("td").data(function(a,b){return a}).enter().append("td").text(function(a,b){return a}).style("background-color",function(a,b){return i.domain([d3.min(m(g,b)),d3.max(m(g,b))]),"rgba("+h[b].r+","+h[b].g+","+h[b].b+","+i(a)+")"}):!q&&r?p=s.selectAll("td").data(function(a,b){return a}).enter().append("td").text(function(a,b){return a}).style("font-size",function(a,b){return l.domain([d3.min(m(g,b)),d3.max(m(g,b))]),l(a)+"px"}):(console.log("We are here baby!"),s.style("background-color",function(a,c){return k.domain([d3.min(m(g,b.xAxis)),d3.max(m(g,b.xAxis))]),k(a[b.xAxis])}).style("font-size",function(a,b){return l.domain([d3.min(m(g,b)),d3.max(m(g,b))]),l(a)+"px"}),p=s.selectAll("td").data(function(a,b){return a}).enter().append("td").text(function(a,b){return a}));return j},b.extend=function(a){for(var b,c,d=1,e=arguments.length;e>d;++d){b=arguments[d];for(c in b)a[c]=b[c]}return a},n.prototype.setXAxis=function(a){var b=this.spec.axes[0];return a.hasOwnProperty("zero")&&(this.spec.scales[0].zero=a.zero),a.hasOwnProperty("nice")&&(this.spec.scales[0].nice=a.nice),k(a,b),this},n.prototype.setYAxis=function(a){var b=this.spec.axes[1];return a.hasOwnProperty("zero")&&(this.spec.scales[1].zero=a.zero),a.hasOwnProperty("nice")&&(this.spec.scales[1].nice=a.nice),k(a,b),this},n.prototype.setPadding=function(a){this.spec.hasOwnProperty("padding")||(this.spec.padding={},this.spec.padding.top=0,this.spec.padding.bottom=0,this.spec.padding.left=0,this.spec.padding.right=0);for(var b in a)a.hasOwnProperty(b)&&(this.spec.padding[b]=a[b]);return this.spec.width=this.originalWidth-this.spec.padding.left-this.spec.padding.right,this.spec.height=this.originalHeight-this.spec.padding.top-this.spec.padding.bottom,this},n.prototype.unsetPadding=function(){return delete this.spec.padding,this.spec.width=this.originalWidth,this.spec.height=this.originalHeight,this},n.prototype.setDimension=function(a){a.hasOwnProperty("width")&&(this.spec.width=a.width,this.originalWidth=a.width),a.hasOwnProperty("height")&&(this.spec.height=a.height,this.originalHeight=a.height)},n.prototype.update=function(a){var b=i([a],this.dataTable.metadata);"slide"==this.config.update&&(this.table.shift(),this.dataTable.data.shift()),this.dataTable.data.push(a),console.log(dataTable.data),this.table.push(b[0]),this.chart.data(this.data).update({duration:500})},n.prototype.updateList=function(a){for(var b=a.dataList,c=0;c<b.length;c++)"slide"==this.config.update&&this.dataTable.data.shift(),this.dataTable.data.push(b[c]);for(var d=i(b,this.dataTable.metadata),c=0;c<b.length;c++)"slide"==this.config.update&&this.table.shift(),this.table.push(d[c]);this.chart.data(this.data).update({duration:500})},n.prototype.resize=function(){var a=this,b=(document.getElementById(a.canvas.replace("#","")).offsetHeight,document.getElementById(a.canvas.replace("#","")).offsetWidth,a.spec.width),c=a.spec.height;console.log(b,c),a.chart.width(b).height(c).renderer("svg").update({props:"enter"}).update()},n.prototype.plot=function(a,b){this.dataTable.data=a,o(this.dataTable,this.config.xAxis);var c=i(a,this.dataTable.metadata);this.config.hasOwnProperty("yAxis")&&this.config.yAxis.constructor==Array&&(this.spec.scales[1].domain.field=p(this.dataTable,this.config.yAxis,this.config.aggregate,this.config.xAxis));var d={table:c};void 0==this.config.update&&(this.config.update="slide");var e=this.canvas;this.data=d,this.table=c,console.log(d);var f,g,h,j={};if(this.legend){f=[];for(var k=0;k<a.length;k++){g=a[k][this.legendIndex],h=!1;for(var l=0;l<f.length;l++)if(g==f[l]){h=!0;break}h||f.push(g)}j={duration:600},this.spec.legends[0].values=f}var m=this.spec,n=this.toolTip,q=this.toolTipFunction,r=this;vg.parse.spec(m,function(a){r.chart=a({el:e,renderer:"svg",data:d}).update(),n&&(tool=d3.select("body").append("div").style({position:"absolute",opacity:0,padding:"4px",border:"2px solid ",background:"white"}),r.chart.on("mouseover",q[0]),r.chart.on("mouseout",q[1])),b&&b.call(r),console.log("inside",r)}),console.log(this)},b.DataTable=function(){this.metadata={},this.metadata.names=[],this.metadata.types=[],this.data=[]},b.DataTable.prototype.addColumn=function(a,b){this.metadata.names.push(a),this.metadata.types.push(b)},b.DataTable.prototype.addRow=function(a){this.data.push(a)},b.DataTable.prototype.addRows=function(a){for(var b=0;b<a.length;b++)this.data.push(a[b])},b.DataTable.prototype.getColumnNames=function(){return this.metadata.names},b.DataTable.prototype.getColumnByName=function(a){for(var b={},c=0;c<this.metadata.names.length;c++)if(this.metadata.names[c]==a)return b.name=this.metadata.names[c],b.type=this.metadata.types[c],b},b.DataTable.prototype.getColumnByIndex=function(a){var b=this.metadata.names[a];return b?(b.name=b,b.type=this.metadata.types[a],b):void 0},b.DataTable.prototype.getColumnData=function(a){var b=[];return this.data.map(function(c){b.push(c[a])}),b},b.DataTable.prototype.toJSON=function(){console.log(this)}}(window.igviz||{});